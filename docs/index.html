<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Task Website</title>
  <link href="output.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabase = window.supabase?.createClient(
      'https://upyhxhtasgfdelxnpupb.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVweWh4aHRhc2dmZGVseG5wdXBiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwOTQ5OTUsImV4cCI6MjA2ODY3MDk5NX0.qfPqpUsA96mo5PuKH27SVPrXONfzNQaY-fDjQOiSYcY'
    );

    async function logout() {
      await supabase.auth.signOut();
      window.location.href = 'login.html';
    }

    supabase.auth.getUser().then(({ data }) => {
      if (!data.user) location.replace('login.html');
      else {
        window.currentUser = data.user;
        document.documentElement.style.display = '';
        init();
      }
    });

    document.documentElement.style.display = 'none';
  </script>
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen px-4 py-10">
  <header class="bg-white shadow mb-8">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <a href="index.html" class="flex items-center space-x-2 text-blue-600 font-bold text-lg">
        <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
          <path d="M10 2a8 8 0 100 16 8 8 0 000-16zm1 12H9v-2h2v2zm0-4H9V6h2v4z"/>
        </svg>
        <span>Taskolo</span>
      </a>
      <nav class="space-x-4 text-sm text-gray-700">
        <a href="index.html" class="text-blue-600 font-semibold">Home</a>
        <a href="settings.html" class="hover:text-blue-600">Settings</a>
        <a href="#" onclick="logout()" class="hover:text-blue-600">Logout</a>
      </nav>
    </div>
  </header>

  <main class="max-w-3xl mx-auto bg-white rounded-xl shadow-md p-6 space-y-6">
    <h1 class="text-2xl font-bold mb-4">To-Do Tracker</h1>
    <form onsubmit="event.preventDefault(); addTodo();" class="space-y-4">
      <input id="taskInput" placeholder="New task" required class="w-full px-4 py-2 border rounded" />
      <textarea id="noteInput" placeholder="Optional note" class="w-full px-4 py-2 border rounded"></textarea>
      <input id="linkInput" placeholder="Related URL (optional)" class="w-full px-4 py-2 border rounded" />
      <input type="date" id="dueDateInput" required class="w-full px-4 py-2 border rounded" />
      <select id="priorityInput" class="w-full px-4 py-2 border rounded">
        <option value="">--Priority--</option>
        <option>High</option>
        <option>Medium</option>
        <option>Low</option>
      </select>
      <select id="tagInput" class="w-full px-4 py-2 border rounded"><option value="">--Tag--</option></select>
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Add</button>
    </form>

    <div class="flex items-center space-x-4">
      <label for="priorityFilter">Filter by Priority:</label>
      <select id="priorityFilter" onchange="renderTodos()" class="px-2 py-1 border rounded">
        <option value="">--All--</option>
        <option>High</option>
        <option>Medium</option>
        <option>Low</option>
      </select>

      <label for="tagFilter">Filter by Tag:</label>
      <select id="tagFilter" onchange="renderTodos()" class="px-2 py-1 border rounded">
        <option value="">--All--</option>
      </select>
    </div>

    <div id="todoList" class="space-y-4"></div>
  </main>

  <footer class="text-center text-xs text-gray-500 mt-12">
    Crafted by <a href="https://www.linkedin.com/in/kiernan-dimeglio/" class="text-blue-600">Kiernan DiMeglio</a>
  </footer>

  <script>
    let todos = [];
    let user = null;
    let tagSettings = JSON.parse(localStorage.getItem('tagSettings')) || {
      Work: '#f39c12',
      Personal: '#3498db',
      Academic: '#2ecc71'
    };

    async function init() {
      user = window.currentUser;
      const { data } = await supabase.from('todos')
        .select('*')
        .eq('user_id', user.id)
        .order('due_date', { ascending: true });
      todos = data || [];
      populateTagOptions();
      renderTodos();
    }

    async function addTodo() {
      const task = document.getElementById('taskInput').value;
      const note = document.getElementById('noteInput').value;
      const link = document.getElementById('linkInput').value;
      const priority = document.getElementById('priorityInput').value;
      const tag = document.getElementById('tagInput').value;
      const dueDate = document.getElementById('dueDateInput').value;
      if (!task.trim() || !dueDate) return;

      const { data } = await supabase.from('todos').insert([{
        user_id: user.id, task, note, link, priority, tag, due_date: dueDate,
        completed: false, last_updated: new Date().toISOString()
      }]).select();

      if (data) {
        todos.push(...data);
        renderTodos();
        document.querySelector('form').reset();
      }
    }

    async function updateTodo(todoId, updates) {
      await supabase.from('todos').update(updates).eq('id', todoId);
      const { data } = await supabase.from('todos').select('*').eq('user_id', user.id);
      todos = data || [];
      renderTodos();
    }

    async function deleteTodo(todoId) {
      await supabase.from('todos').delete().eq('id', todoId);
      todos = todos.filter(t => t.id !== todoId);
      renderTodos();
    }

    function renderTodos() {
      const container = document.getElementById('todoList');
      container.innerHTML = '';

      const priorityFilter = document.getElementById('priorityFilter').value;
      const tagFilter = document.getElementById('tagFilter').value;

      todos.filter(todo => {
        return (!priorityFilter || todo.priority === priorityFilter) &&
               (!tagFilter || todo.tag === tagFilter);
      }).forEach(todo => {
        const card = document.createElement('div');
        card.className = 'todo p-4 border rounded bg-white';
        if (tagSettings[todo.tag]) card.style.borderLeft = `8px solid ${tagSettings[todo.tag]}`;

        const title = document.createElement('div');
        title.textContent = todo.task;
        if (todo.completed) title.classList.add('line-through', 'opacity-60');

        const note = document.createElement('textarea');
        note.value = todo.note || '';
        note.onchange = e => updateTodo(todo.id, { note: e.target.value });

        const link = document.createElement('input');
        link.value = todo.link || '';
        link.placeholder = 'Related URL';
        link.onchange = e => updateTodo(todo.id, { link: e.target.value });

        const dueDate = document.createElement('input');
        dueDate.type = 'date';
        dueDate.value = todo.due_date;
        dueDate.onchange = e => updateTodo(todo.id, { due_date: e.target.value });

        const priority = document.createElement('select');
        ['', 'High', 'Medium', 'Low'].forEach(p => {
          const opt = document.createElement('option');
          opt.value = p;
          opt.text = p || '--Priority--';
          if (todo.priority === p) opt.selected = true;
          priority.appendChild(opt);
        });
        priority.onchange = e => updateTodo(todo.id, { priority: e.target.value });

        const tag = document.createElement('select');
        ['', ...Object.keys(tagSettings)].forEach(t => {
          const opt = document.createElement('option');
          opt.value = t;
          opt.text = t || '--Tag--';
          if (todo.tag === t) opt.selected = true;
          tag.appendChild(opt);
        });
        tag.onchange = e => updateTodo(todo.id, { tag: e.target.value });

        const completeBtn = document.createElement('button');
        completeBtn.textContent = todo.completed ? 'Undo' : 'Complete';
        completeBtn.onclick = () => updateTodo(todo.id, { completed: !todo.completed });

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Delete';
        deleteBtn.onclick = () => deleteTodo(todo.id);

        card.append(title, note, link, dueDate, priority, tag, completeBtn, deleteBtn);
        container.appendChild(card);
      });
    }

    function populateTagOptions() {
      const tagSelect = document.getElementById('tagInput');
      const tagFilter = document.getElementById('tagFilter');
      tagSelect.innerHTML = '<option value="">--Tag--</option>';
      tagFilter.innerHTML = '<option value="">--All--</option>';
      Object.keys(tagSettings).forEach(tag => {
        const opt1 = document.createElement('option');
        opt1.value = tag;
        opt1.textContent = tag;
        tagSelect.appendChild(opt1);

        const opt2 = document.createElement('option');
        opt2.value = tag;
        opt2.textContent = tag;
        tagFilter.appendChild(opt2);
      });
    }

    function exportCSV() {
      const headers = ['Task','Note','Link','DueDate','Priority','Tag','Completed'];
      const rows = todos.map(t => [t.task, t.note, t.link, t.due_date, t.priority, t.tag, t.completed]);
      const csv = [headers, ...rows].map(row => row.map(item => `"${item || ''}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'todos.csv';
      a.click();
    }

    async function importCSV(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async e => {
        const lines = e.target.result.split('\n').filter(Boolean);
        const [header, ...data] = lines;
        if (!/^"Task","Note","Link","DueDate","Priority","Tag","Completed"$/.test(header.trim())) {
          alert('Invalid CSV format');
          return;
        }
        const inserts = data.map(line => {
          const [task, note, link, due_date, priority, tag, completed] = line.split(',').map(v => v.replace(/"/g, ''));
          return {
            user_id: user.id,
            task, note, link, due_date,
            priority, tag,
            completed: completed === 'true',
            last_updated: new Date().toISOString()
          };
        });
        await supabase.from('todos').insert(inserts);
        await init();
      };
      reader.readAsText(file);
    }
  </script>
</body>
</html>
